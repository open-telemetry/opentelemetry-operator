apiVersion: v1
kind: Pod
metadata:
  name: my-dotnet-initcontainer
  labels:
    app: my-dotnet-initcontainer
  annotations:
    instrumentation.opentelemetry.io/inject-dotnet: "true"
    instrumentation.opentelemetry.io/container-names: "dotnet-init"
spec:
  securityContext:
    runAsUser: 1000
    runAsGroup: 3000
    fsGroup: 3000
  initContainers:
  - name: dotnet-init
    image: ghcr.io/open-telemetry/opentelemetry-operator/e2e-test-app-dotnet:main
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
    env:
    - name: ASPNETCORE_URLS
      value: "http://+:8080"
    command: ["/bin/bash", "-c"]
    # Start app, generate telemetry, wait for flush, then exit
    args:
      - |
        echo ".NET init container starting"
        # Start the .NET app in the background (self-contained executable)
        /app/DiceRoller &
        APP_PID=$!
        sleep 10
        # Stop the app
        kill $APP_PID 2>/dev/null || true
        echo ".NET init container completed"
        exit 0
  containers:
  - name: main-app
    image: busybox:latest
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
    command: ["sleep", "infinity"]
