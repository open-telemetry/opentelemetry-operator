apiVersion: v1
kind: Pod
metadata:
  name: my-java-initcontainer
  labels:
    app: my-java-initcontainer
  annotations:
    instrumentation.opentelemetry.io/inject-java: "true"
    instrumentation.opentelemetry.io/container-names: "java-init"
spec:
  securityContext:
    runAsUser: 1000
    runAsGroup: 3000
    fsGroup: 3000
  initContainers:
  - name: java-init
    image: ghcr.io/open-telemetry/opentelemetry-operator/e2e-test-app-java:main
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
    command: ["/bin/bash", "-c"]
    # Start app, generate telemetry, wait for flush, then exit
    args:
      - |
        echo "Java init container starting"
        # Start the Java app in the background
        java -jar /app-0.0.1-SNAPSHOT.jar &
        APP_PID=$!
        sleep 10
        # Stop the app
        kill $APP_PID 2>/dev/null || true
        echo "Java init container completed"
        exit 0
  containers:
  - name: main-app
    image: busybox:latest
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
    command: ["sleep", "infinity"]
