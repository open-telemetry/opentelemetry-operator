# yaml-language-server: $schema=https://raw.githubusercontent.com/kyverno/chainsaw/main/.schemas/json/test-chainsaw-v1alpha1.json
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: ta-collector-mtls-scrapeconfig-node
spec:
  steps:
  - name: step-00
    try:
    - apply:
        file: 00-install.yaml
    - assert:
        file: 00-assert.yaml
    catch:
    - podLogs:
        selector: app.kubernetes.io/managed-by=opentelemetry-operator
    - podLogs:
        selector: checker=true
  - name: step-01
    try:
      - create:
          template: false
          resource:
            apiVersion: monitoring.coreos.com/v1alpha1
            kind: ScrapeConfig
            metadata:
              name: scrape-config-cr
            spec:
              kubernetesSDConfigs:
                - role: Node
              relabelings:
                - action: labelmap
                  regex: __meta_kubernetes_node_label_(.+)
                  replacement: $1
                  separator: ;
                - action: replace
                  regex: (.*)
                  replacement: kubernetes.default.svc:443
                  separator: ;
                  targetLabel: __address__
                - action: replace
                  regex: (.+)
                  replacement: /api/v1/nodes/$1/proxy/metrics
                  separator: ;
                  sourceLabels:
                    - __meta_kubernetes_node_name
                  targetLabel: __metrics_path__
              scheme: HTTPS
              authorization:
                type: Bearer
                credentials:
                  key: "token"
                  name: "collector"
              tlsConfig:
                ca:
                  secret:
                    key: "ca.crt"
                    name: "collector"
                insecureSkipVerify: false
      - apply:
          template: true
          bindings:
            - name: namespace
              value: ($namespace)
          file: 01-install.yaml
      - assert:
          file: 01-assert.yaml
    catch:
      - podLogs:
          selector: app.kubernetes.io/managed-by=opentelemetry-operator
      - podLogs:
          selector: checker=true
