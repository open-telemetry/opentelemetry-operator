apiVersion: v1
automountServiceAccountToken: true
kind: ServiceAccount
metadata:
  name: collector
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: (join('-', ['collector', $namespace]))
rules:
  - apiGroups:
      - ""
    resources:
      - pods
      - nodes
      - nodes/metrics
      - services
      - endpoints
      - namespaces
    verbs:
      - get
      - watch
      - list
  - apiGroups:
      - networking.k8s.io
    resources:
      - ingresses
    verbs:
      - get
      - watch
      - list
  - nonResourceURLs:
      - /metrics
      - /metrics/cadvisor
    verbs:
      - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: (join('-', ['collector', $namespace]))
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: (join('-', ['collector', $namespace]))
subjects:
  - kind: ServiceAccount
    name: collector
    namespace: ($namespace)
---
apiVersion: opentelemetry.io/v1alpha1
kind: OpenTelemetryCollector
metadata:
  name: prometheus-cr
spec:
  config: |
    receivers:
      otlp:
        protocols:
          grpc:
          http:
    processors:

    exporters:
      debug:

    service:
      pipelines:
        traces:
          receivers: [otlp]
          exporters: [debug]
  mode: statefulset
  serviceAccount: collector
  targetAllocator:
    enabled: false
