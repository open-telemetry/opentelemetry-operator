apiVersion: v1
automountServiceAccountToken: true
kind: ServiceAccount
metadata:
  name: ta-common
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: metrics-consistency-ta
rules:
- apiGroups:
  - ""
  resources:
  - pods
  - services
  - endpoints
  verbs:
  - get
  - watch
  - list
- apiGroups:
  - apps
  resources:
  - statefulsets
  verbs:
  - get
  - watch
  - list
- apiGroups:
  - discovery.k8s.io
  resources:
  - endpointslices
  verbs:
  - get
  - watch
  - list
- apiGroups:
  - networking.k8s.io
  resources:
  - ingresses
  verbs:
  - get
  - watch
  - list
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: ta-($namespace)
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: metrics-consistency-ta
subjects:
- kind: ServiceAccount
  name: ta-common
  namespace: ($namespace)
---
# Target Allocator with OTel Collector
apiVersion: opentelemetry.io/v1beta1
kind: OpenTelemetryCollector
metadata:
  name: ta-distributed
  labels:
    collector-type: ta-distributed
spec:
  mode: statefulset
  replicas: 2
  targetAllocator:
    allocationStrategy: least-weighted
    serviceAccount: ta-common
    enabled: true
    prometheusCR:
      enabled: false 
      serviceMonitorSelector: { }
      podMonitorSelector: { }
  config: 
    receivers:
      prometheus:
        config:
          global:
            scrape_interval: 10s
          scrape_configs:
          - job_name: 'static-targets'
            static_configs:
            - targets: 
              - 'fake-app-1:8081'
              - 'fake-app-1:8082'
              - 'fake-app-1:8083'
              - 'fake-app-1:8084'
              - 'fake-app-1:8085'
              labels:
                env: 'test'
                team: 'platform'
            relabel_configs:
            - source_labels: [__address__]
              action: replace
              regex: ([^:]+):.*
              replacement: $1:8080
              target_label: __address__
            - source_labels: [env]
              target_label: environment
            - source_labels: [team]
              target_label: team_label
            metric_relabel_configs:
            - source_labels: [__name__]
              action: keep
              regex: "^up$"
            - source_labels: [job_sign]
              action: replace
              regex: ".*"
              replacement: duplicate_job
              target_label: job_sign
          - job_name: 'k8s-blackbox-discovery'
            kubernetes_sd_configs:
            - role: pod
              namespaces:
                names:
                - ($namespace)
            relabel_configs:
            - source_labels: [__meta_kubernetes_pod_label_app]
              action: keep
              regex: blackbox-exporter
            - source_labels: [__address__]
              action: replace
              regex: ([^:]+):.*
              replacement: $1:9115
              target_label: __address__
            - source_labels: [__meta_kubernetes_pod_name]
              target_label: pod_name
            - source_labels: [__meta_kubernetes_namespace]
              target_label: kubernetes_namespace
            metric_relabel_configs:
            - source_labels: [__name__]
              action: keep
              regex: "^up$"
            - source_labels: [job_sign]
              action: replace
              regex: ".*"
              replacement: single_job
              target_label: job_sign
    processors:
      # Ensure metrics are flushed to the exporter at least once
      batch:
        send_batch_size: 1000
        timeout: 20s
    exporters:
      prometheus:
        endpoint: "0.0.0.0:8889"
    service:
      pipelines:
        metrics:
          receivers: [prometheus]
          processors: [batch]
          exporters: [prometheus]