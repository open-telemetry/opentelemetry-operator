# yaml-language-server: $schema=https://raw.githubusercontent.com/kyverno/chainsaw/main/.schemas/json/test-chainsaw-v1alpha1.json
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: webhook-metrics-java
spec:
  description: |
    Test that pod mutation webhook metrics are exposed when a Java app is instrumented.
    Verifies the opentelemetry_operator_pod_mutations_total metric is recorded with correct labels.
  steps:
    - name: Add OpenShift namespace annotations
      use:
        template: ../../step-templates/openshift-namespace-annotations.yaml
    
    - name: step-00-install-instrumentation
      description: Install Java Instrumentation CR
      try:
        - apply:
            file: 00-install-instrumentation.yaml
    
    - name: step-01-install-app
      description: Deploy a pod with Java instrumentation annotation
      try:
        - apply:
            file: 01-install-app.yaml
        - assert:
            file: 01-assert.yaml
      catch:
        - podLogs:
            selector: app=java-test-app
    
    - name: step-02-get-operator-service
      description: Get the operator service name for metrics access
      try:
        - command:
            entrypoint: kubectl
            args:
              - get
              - service
              - -n
              - opentelemetry-operator-system
              - -l
              - app.kubernetes.io/name=opentelemetry-operator
              - -o
              - jsonpath={.items[0].metadata.name}
            outputs:
              - name: serviceName
                value: ($stdout)
    
    - name: step-03-verify-webhook-metrics
      description: Verify pod mutation metrics are exposed on operator's metrics endpoint
      try:
        - script:
            env:
              - name: serviceName
                value: ($serviceName)
              - name: OPERATOR_NAMESPACE
                value: "opentelemetry-operator-system"
            timeout: 120s
            content: |
              #!/bin/sh
              set -e
              
              echo "Using service: ${serviceName}"
              
              # DEBUG: Print operator deployment args to verify the flag is present
              echo ""
              echo "=== Operator Deployment Args ==="
              kubectl get deployment -n ${OPERATOR_NAMESPACE} -o jsonpath='{.items[0].spec.template.spec.containers[0].args}' | tr ',' '\n'
              echo ""
              
              # Fetch metrics using kubectl get --raw (this handles authentication)
              echo ""
              echo "=== Fetching metrics via kubectl get --raw ==="
              for i in 1 2 3 4 5 6 7 8 9 10; do
                echo "Attempt $i to fetch metrics..."
                # Use kubectl get --raw to access the metrics endpoint with proper auth
                METRICS=$(kubectl get --raw "/api/v1/namespaces/${OPERATOR_NAMESPACE}/services/${serviceName}:8443/proxy/metrics" 2>/dev/null || true)
                if echo "$METRICS" | grep -q "opentelemetry_operator_pod_mutations_total"; then
                  echo "Found metric!"
                  break
                fi
                sleep 3
              done
              
              # Debug: Print pod details to see if mutation happened
              echo ""
              echo "=== Checking if mutation actually happened ==="
              kubectl get pod -n ${NAMESPACE} java-test-app -o yaml | grep "initContainers" -A 5 || echo "No initContainers found!"
              
              # Check for the expected metric
              if echo "$METRICS" | grep -q "opentelemetry_operator_pod_mutations_total"; then
                echo ""
                echo "SUCCESS: Found opentelemetry_operator_pod_mutations_total metric"
                
                # Verify specific labels
                if echo "$METRICS" | grep -q 'mutation_type="instrumentation"'; then
                  echo "SUCCESS: Found mutation_type=instrumentation label"
                else
                  echo "WARNING: mutation_type label not found (may be OK if no mutations yet)"
                fi
                
                if echo "$METRICS" | grep -q 'status="success"'; then
                  echo "SUCCESS: Found status=success label"
                else
                  echo "INFO: status=success not found yet (metrics may not be recorded yet)"
                fi
                
                if echo "$METRICS" | grep -q 'language="java"'; then
                  echo "SUCCESS: Found language=java label"
                else
                  echo "INFO: language=java not found yet"
                fi
                
                echo ""
                echo "=== METRICS OUTPUT ==="
                echo "$METRICS" | grep "opentelemetry_operator_pod_mutations_total" || echo "(no matching lines)"
                exit 0
              else
                echo ""
                echo "ERROR: opentelemetry_operator_pod_mutations_total metric not found"
                echo ""
                echo "=== All metrics containing 'opentelemetry' ==="
                echo "$METRICS" | grep -i "opentelemetry" | head -30 || echo "(none found)"
                echo ""
                echo "=== First 50 lines of metrics output ==="
                echo "$METRICS" | head -50
                exit 1
              fi
