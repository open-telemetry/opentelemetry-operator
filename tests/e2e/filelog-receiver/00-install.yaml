---
apiVersion: opentelemetry.io/v1beta1
kind: OpenTelemetryCollector
metadata:
  name: filelog
spec:
  mode: sidecar
  image: otel/opentelemetry-collector-k8s
  volumeMounts:
  - name: logs
    mountPath: /var/log/app
  ports:
    - port: 8888
      protocol: TCP
      name: metrics
  config:
    receivers:
      filelog:
        include:
        - /var/log/app/*.log
        operators:
        - type: regex_parser
          regex: '^(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) \[(?P<level>\w+)\] (?P<message>.*)$'
          timestamp:
            parse_from: attributes.timestamp
            layout: '%Y-%m-%d %H:%M:%S'
        - type: move
          from: attributes.level
          to: attributes["log.level"]
        - type: move
          from: attributes.message
          to: body
    processors: {}
    exporters:
      debug:
        verbosity: detailed
    service:
      pipelines:
        logs:
          receivers: [filelog]
          processors: []
          exporters: [debug]
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: log-generator-plaintext
data:
  generate-logs.sh: |
    #!/bin/sh
    while true; do
      log_line="$(date '+%Y-%m-%d %H:%M:%S') [INFO] Plain text log entry from application"
      echo "$log_line" | tee -a /var/log/app/plaintext.log
      sleep 5
    done
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: log-generator
  labels:
    app: log-generator
spec:
  replicas: 1
  selector:
    matchLabels:
      app: log-generator
  template:
    metadata:
      labels:
        app: log-generator
      annotations:
        sidecar.opentelemetry.io/inject: "true"
    spec:
      containers:
      - name: app
        image: busybox:latest
        command: ["/bin/sh", "/scripts/generate-logs.sh"]
        volumeMounts:
        - name: scripts
          mountPath: /scripts
        - name: logs
          mountPath: /var/log/app
      volumes:
      - name: scripts
        configMap:
          name: log-generator-plaintext
          defaultMode: 0755
      - name: logs
        emptyDir: {}
