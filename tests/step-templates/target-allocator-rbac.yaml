apiVersion: chainsaw.kyverno.io/v1alpha1
kind: StepTemplate
metadata:
  name: target-allocator-rbac
spec:
  bindings:
    - name: serviceAccountName
      value: ta
    - name: clusterRoleName
      value: (join('-', ['targetallocator', $namespace]))
    - name: clusterRoleBindingName
      value: (join('-', ['default-view', $namespace]))
  try:
    - apply:
        resource:
          apiVersion: v1
          automountServiceAccountToken: true
          kind: ServiceAccount
          metadata:
            name: ($serviceAccountName)
    - apply:
        resource:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: ($clusterRoleName)
          rules:
          - apiGroups:
            - ""
            resources:
            - pods
            - namespaces
            - nodes
            verbs:
            - get
            - list
            - watch
          - apiGroups:
            - monitoring.coreos.com
            resources:
            - servicemonitors
            verbs:
            - get
            - list
            - watch
          - nonResourceURLs:
              - /metrics
              - /apis
              - /apis/*
              - /api
              - /api/*
            verbs:
              - get
    - apply:
        resource:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: ($clusterRoleBindingName)
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: ($clusterRoleName)
          subjects:
          - kind: ServiceAccount
            name: ($serviceAccountName)
            namespace: ($namespace)